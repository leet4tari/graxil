<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHA3x Mining Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            margin: 0;
            padding: 20px;
            transition: all 0.3s ease;
        }

        /* Light theme */
        body.light-theme {
            background: linear-gradient(135deg, #f0f2f0 0%, #e8f4fd 100%);
            color: #333;
        }

        body.light-theme .stat-card,
        body.light-theme .tab-content,
        body.light-theme .tab-nav {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        body.light-theme .tab-btn {
            color: rgba(0, 0, 0, 0.7);
        }

        body.light-theme .tab-btn.active,
        body.light-theme .tab-btn:hover {
            color: #333;
        }

        body.light-theme canvas {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .stat-card h3 {
            color: #2e7d32;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        body.light-theme .theme-toggle {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-theme .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px 15px 0 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 25px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-bottom-color: #4CAF50;
        }

        /* Tab Content */
        .tab-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            padding: 25px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 1.1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        /* Charts Styles */
        .graph-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .graph-container h3 {
            margin: 0 0 15px 0;
            flex-shrink: 0;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
            overflow: hidden;
        }

        .graph-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .graph-full {
            grid-column: 1 / -1;
            height: 400px;
        }

        canvas {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .tab-nav {
                flex-direction: column;
            }
            
            .graph-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* Stack cards vertically on mobile */
            .stats-grid .stat-card {
                grid-column: span 1 !important;
            }
        }

        /* Status indicators */
        .status-online {
            color: #4CAF50;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="dark-theme">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Theme">üåô</button>
    
    <div class="container">
        <div class="header">
            <h1>‚õèÔ∏è SHA3x Mining Dashboard</h1>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('charts')">üìà Live Charts</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <div class="stats-grid">
                    <!-- Enhanced Overview Card with CPU/GPU Breakdown -->
                    <div class="stat-card">
                        <h3>üìä Mining Overview</h3>
                        <div class="stat-value" id="total-hashrate">0.00 MH/s</div>
                        <div class="stat-label">Total Combined Hashrate</div>
                        <div style="margin-top: 15px;">
                            <div class="stat-label">CPU: <span id="cpu-hashrate">0.00 MH/s</span> (<span id="cpu-usage-overview">0%</span> usage)</div>
                            <div class="stat-label">GPU: <span id="gpu-hashrate">0.00 MH/s</span> (<span id="gpu-usage-overview">0%</span> usage)</div>
                            <div class="stat-label" style="margin-top: 8px;">Algorithm: <span id="algorithm">SHA3x</span></div>
                        </div>
                    </div>

                    <!-- Combined Work Stats & Luck -->
                    <div class="stat-card">
                        <h3>üí™ Work & Performance</h3>
                        <div class="stat-value" id="total-work">0</div>
                        <div class="stat-label">Total Work (Sum of Share Difficulties)</div>
                        <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div class="stat-label">Efficiency: <span id="work-efficiency">0%</span></div>
                                <div class="stat-label">Avg Luck: <span id="average-luck">0.00x</span></div>
                            </div>
                            <div>
                                <div class="stat-label">Best Share: <span id="best-share">0</span></div>
                                <div class="stat-label">Share Rate: <span id="share-rate">0.0/min</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mining Stats -->
                    <div class="stat-card">
                        <h3>‚õèÔ∏è Mining Statistics</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="accepted-shares">0</div>
                                <div class="stat-label">Accepted</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="submitted-shares">0</div>
                                <div class="stat-label">Submitted</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="rejected-shares">0</div>
                                <div class="stat-label">Rejected</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="stat-label">Acceptance: <span id="acceptance-rate">0%</span></div>
                            <div class="stat-label">Last Share: <span id="time-since-last">0s</span></div>
                        </div>
                    </div>

                    <!-- Pool Connection with Real Data -->
                    <div class="stat-card">
                        <h3>üåê Pool Connection</h3>
                        <div class="stat-value status-online">
                            <span class="status-indicator"></span><span id="pool-status">Connecting</span>
                        </div>
                        <div class="stat-label"><span id="pool-address">Unknown</span></div>
                        <div style="margin-top: 10px;">
                            <div class="stat-label">Latency: <span id="pool-latency">--ms</span> | Attempts: <span id="pool-attempts">0</span></div>
                            <div class="stat-label">Pool Uptime: <span id="pool-uptime">--</span></div>
                            <div class="stat-label">Miner Uptime: <span id="uptime">00:00:00</span></div>
                        </div>
                    </div>

                    <!-- CPU Performance Card -->
                    <div class="stat-card">
                        <h3>‚ö° CPU Performance</h3>
                        <div class="stat-value" id="cpu-usage">0%</div>
                        <div class="stat-label">CPU Usage <span id="cpu-current" style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">(Live: 0%)</span></div>
                        <div style="margin-top: 15px;">
                            <div class="stat-label">Memory: <span id="memory-usage">0%</span> (<span id="memory-used">0 GB</span> / <span id="memory-total">0 GB</span>)</div>
                            <div class="stat-label">Active Threads: <span id="active-threads">0</span> / <span id="cpu-cores">0</span> cores</div>
                            <div class="stat-label">CPU Temp: <span id="cpu-temp">--¬∞C</span></div>
                        </div>
                    </div>

                    <!-- System Information Card - Wide -->
                    <div class="stat-card" style="grid-column: span 2;">
                        <h3>üñ•Ô∏è System Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Left Column: Hardware -->
                            <div>
                                <div class="stat-label" style="margin-bottom: 10px;"><strong>Hardware Details</strong></div>
                                <div class="stat-label">CPU: <span id="cpu-name">Unknown</span></div>
                                <div class="stat-label">Cores: <span id="cpu-cores-display">0</span> threads</div>
                                <div class="stat-label">Memory: <span id="memory-total-display">0 GB</span> total</div>
                                <div class="stat-label">Max Temp: <span id="max-temp">--¬∞C</span></div>
                            </div>
                            <!-- Right Column: System Details -->
                            <div>
                                <div class="stat-label" style="margin-bottom: 10px;"><strong>System Details</strong></div>
                                <div class="stat-label">OS: <span id="os-name">Unknown</span></div>
                                <div class="stat-label">Kernel: <span id="kernel-version">Unknown</span></div>
                                <div class="stat-label">Host: <span id="hostname">Unknown</span></div>
                                <div class="stat-label">Mining Uptime: <span id="uptime">00:00:00</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- GPU Performance Card -->
                    <div class="stat-card">
                        <h3>üéÆ GPU Performance</h3>
                        <div class="stat-value" id="gpu-usage">--</div>
                        <div class="stat-label">GPU Usage</div>
                        <div style="margin-top: 15px;">
                            <div class="stat-label">GPU: <span id="gpu-name">Detecting...</span></div>
                            <div class="stat-label">Memory: <span id="gpu-memory">-- / -- GB</span></div>
                            <div class="stat-label">Temperature: <span id="gpu-temp">--¬∞C</span></div>
                            <div class="stat-label">Power: <span id="gpu-power">-- W</span></div>
                        </div>
                    </div>
                </div>

                <!-- Current Job Section (spans full width) -->
                <div class="stat-card" style="margin-top: 20px;">
                    <h3>üìã Mining Jobs</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                        <!-- Current Job -->
                        <div>
                            <h4 style="color: #4CAF50; margin-bottom: 10px;">Current Job</h4>
                            <div id="current-job-info" style="font-family: monospace; font-size: 0.9rem;">
                                <div style="color: rgba(255,255,255,0.6);">Waiting for job...</div>
                            </div>
                        </div>
                        <!-- Recent Jobs -->
                        <div>
                            <h4 style="color: #4CAF50; margin-bottom: 10px;">Recent Jobs (Last 5)</h4>
                            <div id="recent-jobs" style="font-family: monospace; font-size: 0.85rem; max-height: 120px; overflow-y: auto;">
                                <div style="color: rgba(255,255,255,0.6);">No job history yet...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shares Section -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Recent Shares List -->
                    <div class="stat-card" style="height: 300px;">
                        <h3>üíé Recent Shares Found</h3>
                        <div id="recent-shares" style="height: 240px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                            <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">
                                Waiting for shares...
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Shares -->
                    <div class="stat-card" style="height: 300px;">
                        <h3>üèÜ Top 5 Shares</h3>
                        <div id="top-shares" style="height: 240px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="color: rgba(255,255,255,0.6); text-align: center;">
                                No shares yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div id="charts" class="tab-pane">
                <div class="graph-grid">
                    <!-- Hashrate Chart -->
                    <div class="graph-container">
                        <h3>‚ö° Hashrate (Last 5 Minutes)</h3>
                        <div class="chart-wrapper">
                            <canvas id="hashrateChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Share Rate Chart -->
                    <div class="graph-container">
                        <h3>üéØ Share Rate (Per Minute)</h3>
                        <div class="chart-wrapper">
                            <canvas id="shareChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Thread Performance Chart -->
                <div class="graph-container graph-full">
                    <h3>üßµ Thread Performance</h3>
                    <div class="chart-wrapper">
                        <canvas id="threadChart"></canvas>
                    </div>
                </div>
                
                <!-- Efficiency Chart -->
                <div class="graph-container graph-full">
                    <h3>üìä Mining Efficiency & Luck Trends</h3>
                    <div class="chart-wrapper">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let chartsInitialized = false;
        let charts = {};
        let lastShareCount = 0;  // Track total shares to calculate rate
        let cpuUsageHistory = [];  // Track CPU usage for moving average

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Initialize charts when charts tab is first opened
            if (tabName === 'charts' && !chartsInitialized) {
                initializeCharts();
                chartsInitialized = true;
            }
        }

        // Initialize WebSocket connection
        function initWebSocket() {
            try {
                socket = new WebSocket('ws://localhost:8080/ws');
                
                socket.onopen = function() {
                    console.log('üìä Connected to SHA3x-Miner data!');
                    document.getElementById('connection-status').textContent = 'Connected to SHA3x-Miner';
                    document.getElementById('connection-status').style.color = '#4CAF50';
                };
                
                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üìä Received real miner data:', data);
                        updateDashboard(data);
                        if (chartsInitialized) {
                            updateCharts(data);
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket data:', error);
                    }
                };
                
                socket.onclose = function() {
                    console.log('üìä Real miner connection lost - check if miner is running with --web flag');
                    document.getElementById('connection-status').textContent = 'Disconnected - Start miner with --web';
                    document.getElementById('connection-status').style.color = '#f44336';
                    // Attempt reconnection after 5 seconds
                    setTimeout(initWebSocket, 5000);
                };
                
                socket.onerror = function() {
                    console.log('üìä WebSocket error - make sure miner is running with --web flag');
                    document.getElementById('connection-status').textContent = 'Connection Error - Check Miner';
                    document.getElementById('connection-status').style.color = '#ff9800';
                };
            } catch (error) {
                console.log('üìä WebSocket unavailable - start miner with --web flag');
                document.getElementById('connection-status').textContent = 'Waiting for Miner Connection';
                document.getElementById('connection-status').style.color = '#ff9800';
            }
        }

        // Update dashboard elements
        function updateDashboard(data) {
            // HARDCODED: GPU-only mining detection and hashrate assignment
            let cpuHashrate = 0;
            let gpuHashrate = 0;
            
            // Simple GPU detection: If GPU detected and high utilization, it's GPU mining
            if (data.gpu_info && data.gpu_info.detected && data.gpu_info.utilization > 80) {
                // GPU-only mining mode
                gpuHashrate = data.current_hashrate || 0;
                cpuHashrate = 0;
            } else {
                // CPU mining mode (fallback)
                cpuHashrate = data.current_hashrate || 0;
                gpuHashrate = 0;
            }
            
            const totalHashrate = cpuHashrate + gpuHashrate;
            
            // Update total hashrate
            document.getElementById('total-hashrate').textContent = 
                (totalHashrate / 1000000).toFixed(2) + ' MH/s';
            
            // Update CPU mining hashrate
            document.getElementById('cpu-hashrate').textContent = 
                (cpuHashrate / 1000000).toFixed(2) + ' MH/s';
            
            // Update GPU mining hashrate  
            document.getElementById('gpu-hashrate').textContent = 
                (gpuHashrate / 1000000).toFixed(2) + ' MH/s';
            
            // Update algorithm
            document.getElementById('algorithm').textContent = data.algorithm || 'SHA3x';
            
            // Update system usage percentages (will be set later in system_info section)
            // CPU usage will be updated when we process system_info
            // GPU usage will be updated when we process gpu_info

            // Work & Performance section (merged)
            document.getElementById('total-work').textContent = formatNumber(data.total_work || 0);
            document.getElementById('work-efficiency').textContent = (data.work_efficiency || 0).toFixed(1) + '%';
            document.getElementById('average-luck').textContent = (data.average_luck || 0).toFixed(2) + 'x';
            document.getElementById('best-share').textContent = data.top_shares && data.top_shares.length > 0 ? 
                formatNumber(data.top_shares[0]) : '0';
            document.getElementById('share-rate').textContent = (data.share_rate || 0).toFixed(1) + '/min';

            // Mining stats
            document.getElementById('accepted-shares').textContent = data.accepted_shares || 0;
            document.getElementById('submitted-shares').textContent = data.submitted_shares || 0;
            document.getElementById('rejected-shares').textContent = data.rejected_shares || 0;
            document.getElementById('acceptance-rate').textContent = (data.acceptance_rate || 0).toFixed(1) + '%';
            document.getElementById('time-since-last').textContent = formatDuration(data.time_since_last_share || 0);
            
            // System info with both current and average CPU display + new system details
            if (data.system_info) {
                // Add current CPU usage to history
                cpuUsageHistory.push(data.system_info.cpu_usage);
                
                // Keep only last 10 readings (10 seconds of history)
                if (cpuUsageHistory.length > 10) {
                    cpuUsageHistory.shift();
                }
                
                // Calculate moving average
                const avgCpuUsage = cpuUsageHistory.reduce((sum, usage) => sum + usage, 0) / cpuUsageHistory.length;
                const currentCpuUsage = data.system_info.cpu_usage;
                
                // Update CPU Performance card
                document.getElementById('cpu-usage').textContent = avgCpuUsage.toFixed(1) + '%';
                document.getElementById('cpu-current').textContent = `(Live: ${currentCpuUsage.toFixed(1)}%)`;
                
                // Update CPU usage in Mining Overview
                document.getElementById('cpu-usage-overview').textContent = currentCpuUsage.toFixed(1) + '%';
                
                document.getElementById('memory-usage').textContent = data.system_info.memory_usage.toFixed(1) + '%';
                document.getElementById('memory-used').textContent = (data.system_info.memory_used / (1024**3)).toFixed(1);
                document.getElementById('memory-total').textContent = (data.system_info.memory_total / (1024**3)).toFixed(1);
                document.getElementById('active-threads').textContent = data.active_threads || 0;
                document.getElementById('cpu-cores').textContent = data.system_info.cpu_cores || 0;
                document.getElementById('cpu-temp').textContent = data.system_info.cpu_temperature ? 
                    data.system_info.cpu_temperature.toFixed(1) + '¬∞C' : '--¬∞C';
                
                // Update System Information card
                document.getElementById('cpu-name').textContent = data.system_info.cpu_name || 'Unknown';
                document.getElementById('cpu-cores-display').textContent = data.system_info.cpu_cores || 0;
                document.getElementById('memory-total-display').textContent = (data.system_info.memory_total / (1024**3)).toFixed(1);
                document.getElementById('os-name').textContent = data.system_info.os_name || 'Unknown';
                document.getElementById('kernel-version').textContent = data.system_info.kernel_version || 'Unknown';
                document.getElementById('hostname').textContent = data.system_info.hostname || 'Unknown';
                document.getElementById('max-temp').textContent = data.system_info.max_temperature ? 
                    data.system_info.max_temperature.toFixed(1) + '¬∞C' : '--¬∞C';
            }

            // Update GPU Performance card with real data
            console.log('üîß GPU data received:', !!data.gpu_info);
            if (data.gpu_info) {
                console.log('üîß GPU info:', data.gpu_info);
                
                if (data.gpu_info.detected) {
                    console.log('üîß GPU detected, updating display');
                    
                    // Update GPU usage
                    document.getElementById('gpu-usage').textContent = data.gpu_info.utilization ? 
                        data.gpu_info.utilization.toFixed(0) + '%' : '--';
                    
                    // Update GPU name
                    document.getElementById('gpu-name').textContent = data.gpu_info.name || 'Unknown GPU';
                    
                    // Format GPU memory
                    if (data.gpu_info.memory_used !== null && data.gpu_info.memory_used !== undefined && 
                        data.gpu_info.memory_total !== null && data.gpu_info.memory_total !== undefined) {
                        const memUsedGB = (data.gpu_info.memory_used / 1024).toFixed(1);
                        const memTotalGB = (data.gpu_info.memory_total / 1024).toFixed(1);
                        document.getElementById('gpu-memory').textContent = `${memUsedGB} / ${memTotalGB} GB`;
                    } else {
                        document.getElementById('gpu-memory').textContent = '-- / -- GB';
                    }
                    
                    // Update temperature
                    document.getElementById('gpu-temp').textContent = data.gpu_info.temperature ? 
                        data.gpu_info.temperature.toFixed(0) + '¬∞C' : '--¬∞C';
                    
                    // Update power
                    document.getElementById('gpu-power').textContent = data.gpu_info.power_usage ? 
                        data.gpu_info.power_usage.toFixed(0) + ' W' : '-- W';
                    
                    // Update GPU usage in Mining Overview
                    document.getElementById('gpu-usage-overview').textContent = data.gpu_info.utilization ? 
                        data.gpu_info.utilization.toFixed(1) + '%' : '0%';
                    
                    
                    // Update GPU card styling to show detection
                    const gpuCard = document.getElementById('gpu-name').closest('.stat-card');
                    if (gpuCard) {
                        gpuCard.style.borderLeft = '4px solid #4CAF50';
                    }
                    
                } else {
                    console.log('üîß GPU not detected');
                    
                    // GPU not detected - update Mining Overview
                    document.getElementById('gpu-usage-overview').textContent = '0%';
                    
                    // GPU not detected
                    document.getElementById('gpu-usage').textContent = '--';
                    document.getElementById('gpu-name').textContent = 'Not detected';
                    document.getElementById('gpu-memory').textContent = '-- / -- GB';
                    document.getElementById('gpu-temp').textContent = '--¬∞C';
                    document.getElementById('gpu-power').textContent = '-- W';
                    
                    // Update GPU card styling
                    const gpuCard = document.getElementById('gpu-name').closest('.stat-card');
                    if (gpuCard) {
                        gpuCard.style.borderLeft = '4px solid #666';
                    }
                }
            } else {
                console.log('üîß No gpu_info field in WebSocket data - check backend');
                
                // No GPU data from backend
                document.getElementById('gpu-usage').textContent = '??';
                document.getElementById('gpu-name').textContent = 'No GPU data from backend';
                document.getElementById('gpu-memory').textContent = '?? / ?? GB';
                document.getElementById('gpu-temp').textContent = '??¬∞C';
                document.getElementById('gpu-power').textContent = '?? W';
            }
            
            // Update pool connection info
            if (data.pool_info) {
                document.getElementById('pool-status').textContent = data.pool_info.is_connected ? 'Connected' : 'Disconnected';
                document.getElementById('pool-address').textContent = data.pool_info.pool_address || 'Unknown';
                // Display latency with live indicator
                document.getElementById('pool-latency').textContent = data.pool_info.latency_ms ? 
                    data.pool_info.latency_ms + 'ms (live)' : '--ms';
                document.getElementById('pool-attempts').textContent = data.pool_info.connection_attempts || 0;
                document.getElementById('pool-uptime').textContent = data.pool_info.uptime_seconds ? 
                    formatDuration(data.pool_info.uptime_seconds) : '--';
                
                // Update status indicator color
                const statusElement = document.querySelector('.status-online');
                const indicator = document.querySelector('.status-indicator');
                if (data.pool_info.is_connected) {
                    statusElement.style.color = '#4CAF50';
                    indicator.style.background = '#4CAF50';
                } else {
                    statusElement.style.color = '#f44336';
                    indicator.style.background = '#f44336';
                }
            }
            
            // Update miner uptime
            const uptime = new Date((data.uptime || 0) * 1000).toISOString().substr(11, 8);
            document.getElementById('uptime').textContent = uptime;

            // Update job information
            updateJobInfo(data.current_job, data.recent_jobs, data);

            // Update shares displays
            updateRecentShares(data.recent_shares);
            updateTopShares(data.top_shares);
        }

        // Format large numbers (like your console output)
        function formatNumber(num) {
            if (num >= 1_000_000_000) {
                return (num / 1_000_000_000).toFixed(1) + 'B';
            } else if (num >= 1_000_000) {
                return (num / 1_000_000).toFixed(1) + 'M';
            } else if (num >= 1_000) {
                return (num / 1_000).toFixed(1) + 'K';
            } else {
                return num.toString();
            }
        }

        // Format duration like your console output
        function formatDuration(seconds) {
            if (seconds < 60) {
                return seconds + 's';
            } else if (seconds < 3600) {
                return Math.floor(seconds / 60) + 'm';
            } else {
                return (seconds / 3600).toFixed(1) + 'h';
            }
        }

        // Update job information display
        function updateJobInfo(currentJob, recentJobs, data) {
            // Update current job
            const currentJobDiv = document.getElementById('current-job-info');
            if (currentJob) {
                currentJobDiv.innerHTML = `
                    <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <div style="color: #FFD700; font-weight: bold;">${currentJob.job_id}</div>
                        <div style="margin-top: 5px;">
                            <span style="color: rgba(255,255,255,0.8);">Height:</span> 
                            <span style="color: #4CAF50; font-weight: bold;">${currentJob.block_height}</span>
                        </div>
                        <div>
                            <span style="color: rgba(255,255,255,0.8);">Difficulty:</span> 
                            <span style="color: #2196F3; font-weight: bold;">${formatNumber(currentJob.difficulty)}</span>
                        </div>
                    </div>
                `;
            } else {
                currentJobDiv.innerHTML = '<div style="color: rgba(255,255,255,0.6);">Waiting for job...</div>';
            }

            // Update recent jobs
            const recentJobsDiv = document.getElementById('recent-jobs');
            if (recentJobs && recentJobs.length > 0) {
                const jobsHtml = recentJobs.map((job, index) => {
                    const isLatest = index === recentJobs.length - 1;
                    return `
                        <div style="padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); ${isLatest ? 'background: rgba(76,175,80,0.1);' : ''}">
                            <span style="color: ${isLatest ? '#FFD700' : '#FFC107'};">${job.job_id}</span>
                            <span style="color: rgba(255,255,255,0.6); margin-left: 10px;">Height: ${job.block_height}</span>
                            <span style="color: rgba(255,255,255,0.6); margin-left: 10px;">Diff: ${formatNumber(job.difficulty)}</span>
                            <span style="color: rgba(255,255,255,0.5); margin-left: 10px; font-size: 0.8rem;">${formatDuration(data.uptime - job.timestamp)} ago</span>
                        </div>
                    `;
                }).reverse().join(''); // Reverse to show newest first
                recentJobsDiv.innerHTML = jobsHtml;
            } else {
                recentJobsDiv.innerHTML = '<div style="color: rgba(255,255,255,0.6);">No job history yet...</div>';
            }
        }
        function updateRecentShares(shares) {
            const container = document.getElementById('recent-shares');
            if (!shares || shares.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">No shares found yet...</div>';
                return;
            }

            const shareElements = shares.map(share => {
                const luckColor = share.luck_factor >= 2.0 ? '#4CAF50' : 
                                 share.luck_factor >= 1.0 ? '#FFC107' : '#f44336';
                
                // Format time since share was found
                let timeStr;
                if (share.timestamp < 60) {
                    timeStr = share.timestamp + 's ago';
                } else if (share.timestamp < 3600) {
                    const minutes = Math.floor(share.timestamp / 60);
                    timeStr = minutes + 'm ago';
                } else {
                    const hours = Math.floor(share.timestamp / 3600);
                    timeStr = hours + 'h ago';
                }
                
                return `
                    <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #4CAF50; font-weight: bold;">üíé Thread ${share.thread_id}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.8);">
                                Submitted Diff: ${formatNumber(share.difficulty)} | Target Diff: ${formatNumber(share.target)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${luckColor}; font-weight: bold;">${share.luck_factor.toFixed(2)}x</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = shareElements;
        }

        // Update top 5 shares - comma separated like console
        function updateTopShares(topShares) {
            const container = document.getElementById('top-shares');
            if (!topShares || topShares.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center;">No shares yet</div>';
                return;
            }

            // Format as comma-separated string like console output: "472.4M | 406.1M | 303.7M"
            const formattedShares = topShares.map(diff => formatNumber(diff)).join(' | ');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #FFD700; margin-bottom: 15px;">
                        üèÜ Top ${topShares.length} Shares
                    </div>
                    <div style="font-family: monospace; font-size: 1.1rem; color: #4CAF50; line-height: 1.8; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        ${formattedShares}
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 10px;">
                        Best difficulties found this session
                    </div>
                </div>
            `;
        }

        // Initialize charts
        function initializeCharts() {
            const isDarkTheme = document.body.classList.contains('dark-theme');
            const textColor = isDarkTheme ? 'white' : '#333';
            const gridColor = isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                animation: false,
                interaction: {
                    intersect: false
                }
            };

            // Hashrate Chart
            charts.hashrate = new Chart(document.getElementById('hashrateChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Current Hashrate',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Moving Average',
                        data: [],
                        borderColor: '#FFC107',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: { display: true, text: 'MH/s', color: textColor }
                        }
                    }
                }
            });

            // Share Rate Chart
            charts.shares = new Chart(document.getElementById('shareChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Shares per Minute',
                        data: [],
                        backgroundColor: '#2196F3',
                        borderColor: '#1976D2',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: { display: true, text: 'Shares', color: textColor },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Thread Performance Chart
            charts.threads = new Chart(document.getElementById('threadChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: Array.from({length: 72}, (_, i) => ({
                        label: `Thread ${i}`,
                        data: [],
                        borderColor: `hsl(${i * 30}, 70%, 60%)`,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        hidden: true
                    }))
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 6,
                                boxHeight: 6,
                                padding: 8,
                                filter: function(legendItem, chartData) {
                                    const datasetIndex = legendItem.datasetIndex;
                                    const dataset = chartData.datasets[datasetIndex];
                                    return !dataset.hidden && dataset.data.length > 0 && 
                                           dataset.data[dataset.data.length - 1] > 0;
                                }
                            }
                        }
                    },
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: { display: true, text: 'MH/s', color: textColor }
                        }
                    }
                }
            });

            // Efficiency Chart
            charts.efficiency = new Chart(document.getElementById('efficiencyChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Work Efficiency (%)',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        yAxisID: 'y',
                        fill: true
                    }, {
                        label: 'Average Luck',
                        data: [],
                        borderColor: '#FF9800',
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        borderDash: [3, 3]
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: commonOptions.scales.x,
                        y: {
                            ...commonOptions.scales.y,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Efficiency %', color: textColor }
                        },
                        y1: {
                            ...commonOptions.scales.y,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Luck Factor', color: textColor },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Update charts with new data
        function updateCharts(data) {
            if (!chartsInitialized) return;
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            updateHashrateChart(data, timeLabel);
            updateShareChart(data, timeLabel);
            updateThreadChart(data, timeLabel);
            updateEfficiencyChart(data, timeLabel);
        }

        function updateHashrateChart(data, timeLabel) {
            const hashrateInMH = data.current_hashrate / 1000000;
            
            charts.hashrate.data.labels.push(timeLabel);
            charts.hashrate.data.datasets[0].data.push(hashrateInMH);
            
            // Calculate moving average
            const recent = charts.hashrate.data.datasets[0].data.slice(-10);
            const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
            charts.hashrate.data.datasets[1].data.push(avg);
            
            // Limit to 5 minutes of data (300 data points at 1-second intervals)
            const maxPoints = 300;
            if (charts.hashrate.data.labels.length > maxPoints) {
                charts.hashrate.data.labels.shift();
                charts.hashrate.data.datasets[0].data.shift();
                charts.hashrate.data.datasets[1].data.shift();
            }
            
            charts.hashrate.update('none');
        }

        function updateShareChart(data, timeLabel) {
            const now = new Date();
            const timeKey = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // Check if we need to add a new minute bar
            const lastLabel = charts.shares.data.labels[charts.shares.data.labels.length - 1];
            const isNewMinute = charts.shares.data.labels.length === 0 || lastLabel !== timeKey;
            
            if (isNewMinute) {
                // Add new bar for new minute
                charts.shares.data.labels.push(timeKey);
                charts.shares.data.datasets[0].data.push(0);
                
                // Keep only last 20 minutes
                if (charts.shares.data.labels.length > 20) {
                    charts.shares.data.labels.shift();
                    charts.shares.data.datasets[0].data.shift();
                }
                
                // Reset counter for new minute
                lastShareCount = data.submitted_shares || 0;
            } else if (data.submitted_shares) {
                // Update current minute's bar with new shares
                const currentIndex = charts.shares.data.datasets[0].data.length - 1;
                const newShares = data.submitted_shares - lastShareCount;
                
                if (currentIndex >= 0 && newShares > 0) {
                    charts.shares.data.datasets[0].data[currentIndex] += newShares;
                    lastShareCount = data.submitted_shares;
                }
            }
            
            charts.shares.update('none');
        }

        function updateThreadChart(data, timeLabel) {
            if (!data.thread_hashrates || data.thread_hashrates.length === 0) {
                console.log('No thread data available');
                return;
            }

            charts.threads.data.labels.push(timeLabel);
            
            // Update each thread's data and show/hide based on activity
            data.thread_hashrates.forEach((hashrate, index) => {
                if (charts.threads.data.datasets[index]) {
                    const hashrateInMH = hashrate / 1000000;
                    charts.threads.data.datasets[index].data.push(hashrateInMH);
                    
                    // Show active threads, hide inactive ones
                    if (hashrateInMH > 0) {
                        charts.threads.data.datasets[index].hidden = false;
                    } else {
                        charts.threads.data.datasets[index].hidden = true;
                    }
                }
            });
            
            // Hide unused datasets
            for (let i = data.thread_hashrates.length; i < charts.threads.data.datasets.length; i++) {
                charts.threads.data.datasets[i].hidden = true;
            }
            
            // Limit data points to keep chart readable
            const maxPoints = 60;
            if (charts.threads.data.labels.length > maxPoints) {
                charts.threads.data.labels.shift();
                charts.threads.data.datasets.forEach(dataset => {
                    if (dataset.data.length > maxPoints) {
                        dataset.data.shift();
                    }
                });
            }
            
            charts.threads.update('none');
        }

        function updateEfficiencyChart(data, timeLabel) {
            charts.efficiency.data.labels.push(timeLabel);
            charts.efficiency.data.datasets[0].data.push(data.work_efficiency || 0);
            charts.efficiency.data.datasets[1].data.push(data.average_luck || 0);
            
            const maxPoints = 100;
            if (charts.efficiency.data.labels.length > maxPoints) {
                charts.efficiency.data.labels.shift();
                charts.efficiency.data.datasets[0].data.shift();
                charts.efficiency.data.datasets[1].data.shift();
            }
            
            charts.efficiency.update('none');
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeButton = document.querySelector('.theme-toggle');
            
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
                themeButton.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
                themeButton.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            }
            
            // Update chart colors for new theme
            if (chartsInitialized) {
                updateChartTheme();
            }
        }

        // Update chart colors based on theme
        function updateChartTheme() {
            const isLight = document.body.classList.contains('light-theme');
            const textColor = isLight ? '#333' : 'white';
            const gridColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
            
            Object.values(charts).forEach(chart => {
                if (chart.options.scales) {
                    if (chart.options.scales.x) {
                        chart.options.scales.x.ticks.color = textColor;
                        chart.options.scales.x.grid.color = gridColor;
                    }
                    if (chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = textColor;
                        chart.options.scales.y.grid.color = gridColor;
                        if (chart.options.scales.y.title) {
                            chart.options.scales.y.title.color = textColor;
                        }
                    }
                    if (chart.options.scales.y1) {
                        chart.options.scales.y1.ticks.color = textColor;
                        if (chart.options.scales.y1.title) {
                            chart.options.scales.y1.title.color = textColor;
                        }
                    }
                }
                if (chart.options.plugins && chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                chart.update('none');
            });
        }

        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const themeButton = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                themeButton.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.add('dark-theme');
                themeButton.textContent = 'üåô';
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeTheme();
            initWebSocket();
        });
    </script>
</body>
</html>